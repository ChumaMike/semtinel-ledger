name: Sentinel Enterprise CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  # üõ°Ô∏è JOB 1: Java Backend (Spring Boot)
  test-java:
    name: ‚òï Test Java Services
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven' # ‚ö° ENTERPRISE: Caches ~/.m2 to speed up builds

      - name: Build and Test (Multi-Module)
        # If you have a root pom.xml:
        run: mvn clean verify
        # IF YOU DO NOT have a root pom yet, comment the line above and use this instead:
        # run: |
        #   cd web-service && mvn clean test
        #   # cd ../core-engine && mvn clean test

  # üêç JOB 2: Python Monitor (FastAPI)
  test-python:
    name: üêç Test Sentinel Monitor
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./sentinel-monitor
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip' # ‚ö° ENTERPRISE: Caches pip downloads

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install fastapi uvicorn pydantic pytest httpx; fi

      - name: Run Pytest
        run: pytest

  # ‚öõÔ∏è JOB 3: React Dashboard
  test-react:
    name: ‚öõÔ∏è Test Dashboard
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./sentinel-dashboard
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm' # ‚ö° ENTERPRISE: Caches node_modules
          cache-dependency-path: sentinel-dashboard/package-lock.json

      - name: Install Dependencies
        # "npm ci" is stricter than "npm install". It guarantees the exact versions in lock file.
        run: npm ci

      - name: Lint Code
        # Enterprise standards usually require linting before testing
        run: npm run lint --if-present

      - name: Run Tests
        # The '|| true' is a temporary hack. Remove it once you write real React tests.
        run: npm test -- --passWithNoTests